#==========cn2配置==========
port: 7890
socks-port: 7891
redir-port: 7892
mixed-port: 7893
allow-lan: true
bind-address: '*'
mode: rule
log-level: info
ipv6: true
external-controller: :9090
external-ui: dashboard
secret: "your_password_here"

#==========DNS 设置==========
dns:
  enable: true
  ipv6: true
  listen: 0.0.0.0:53
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter:
    - '*.lan'
    - 'localhost.ptlogin2.qq.com'
    - '*.local'  # 防止本地域名泄露
  use-hosts: true
  nameserver:
    - 127.0.0.1:5635  # AdGuard Home
    - 202.96.128.86  # China Telecom DNS 1 (添加)
    - 202.96.134.33  # China Telecom DNS 2 (添加)
  fallback:
    - tls://1.1.1.1:853
    - tls://8.8.8.8:853
    - https://cloudflare-dns.com/dns-query
    - https://dns.google/dns-query
  fallback-filter:
    geoip: true
    geoip-code: CN
    ipcidr:
      - 240.0.0.0/4
  default-nameserver:
    - 127.0.0.1:5635  # AdGuard Home
    - 202.96.128.86  # China Telecom DNS 1 (添加)
    - 202.96.134.33  # China Telecom DNS 2 (添加)
  nameserver-policy:
    'www.google.com': [1.1.1.1, 8.8.8.8]
    '+.github.com': [1.1.1.1, 8.8.8.8]
  cache: true
  cache-size: 8192  # 增加缓存大小以提高性能 (优化)

#==========代理提供商==========
proxy-providers:
  tudou:
    type: http
    url: "https://tudou-dyapi.tudouyun.top/api/v1/client/subscribe?token=f0d5eda7efd87a99e2e94f8790276706"
    interval: 3600
    path: ./proxies/tudou.yaml
    health-check:
      enable: true
      interval: 600
      url: http://www.gstatic.com/generate_204

#==========代理组==========
proxy-groups:
  # Claude 专用代理组（仅包含机场节点）
  - name: Claude
    type: select
    use:
      - tudou

  - name: Auto
    type: url-test
    use:
      - tudou
    url: 'http://www.gstatic.com/generate_204'
    interval: 300
    tolerance: 50

  - name: Fallback
    type: fallback
    use:
      - tudou
    url: 'http://www.gstatic.com/generate_204'
    interval: 300

  - name: LoadBalance
    type: load-balance
    use:
      - tudou
    url: 'http://www.gstatic.com/generate_204'
    interval: 300
    strategy: consistent-hashing

  - name: Proxy
    type: select
    use:
      - tudou
    proxies:
      - Auto
      - Fallback
      - LoadBalance
      - DIRECT

  - name: Streaming
    type: select
    use:
      - tudou
    proxies:
      - Auto
      - Proxy

  - name: Gaming
    type: url-test
    use:
      - tudou
    url: 'http://www.gstatic.com/generate_204'
    interval: 300
    tolerance: 50

  - name: GlobalMedia
    type: select
    proxies:
      - Proxy
      - Auto
      - DIRECT

  - name: Telegram
    type: select
    proxies:
      - Proxy
      - Auto
      - DIRECT

  - name: Apple
    type: select
    proxies:
      - DIRECT
      - Proxy
      - Auto

  - name: Microsoft
    type: select
    proxies:
      - DIRECT
      - Proxy
      - Auto

  - name: AI_Services
    type: select
    use:
      - tudou
    proxies:
      - Auto
      - Proxy
    filter: '(?i)美国|美國|US|United States'

  # 添加中国电信优化代理组
  - name: ChinaTelecom
    type: url-test
    use:
      - tudou
    url: 'http://www.189.cn/test'  # 中国电信测速网址
    interval: 300
    tolerance: 150
    filter: '(?i)中国|CN|China|电信|Telecom'

#==========规则提供商==========
rule-providers:
  reject:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt"
    path: ./ruleset/reject.yaml
    interval: 86400

  icloud:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/icloud.txt"
    path: ./ruleset/icloud.yaml
    interval: 86400

  apple:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/apple.txt"
    path: ./ruleset/apple.yaml
    interval: 86400

  google:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/google.txt"
    path: ./ruleset/google.yaml
    interval: 86400

  proxy:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt"
    path: ./ruleset/proxy.yaml
    interval: 86400

  direct:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt"
    path: ./ruleset/direct.yaml
    interval: 86400

  private:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/private.txt"
    path: ./ruleset/private.yaml
    interval: 86400

  gfw:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/gfw.txt"
    path: ./ruleset/gfw.yaml
    interval: 86400

  greatfire:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/greatfire.txt"
    path: ./ruleset/greatfire.yaml"
    interval: 86400

  cncidr:
    type: http
    behavior: ipcidr
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt"
    path: ./ruleset/cncidr.yaml
    interval: 86400

  lancidr:
    type: http
    behavior: ipcidr
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt"
    path: ./ruleset/lancidr.yaml
    interval: 86400

  telegramcidr:
    type: http
    behavior: ipcidr
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt"
    path: ./ruleset/telegramcidr.yaml
    interval: 86400

  globalmedia:
    type: http
    behavior: classical
    url: "https://cdn.jsdelivr.net/gh/DivineEngine/Profiles@master/Clash/RuleSet/StreamingMedia/Streaming.yaml"
    path: ./ruleset/globalmedia.yaml
    interval: 86400

  microsoft:
    type: http
    behavior: classical
    url: "https://cdn.jsdelivr.net/gh/DivineEngine/Profiles@master/Clash/RuleSet/Extra/Microsoft/Microsoft.yaml"
    path: ./ruleset/microsoft.yaml
    interval: 86400

#==========规则==========
rules:
  # Claude 专用规则
  - DOMAIN-SUFFIX,anthropic.com,Claude
  - DOMAIN-SUFFIX,claude.ai,Claude
  - DOMAIN-KEYWORD,claude,Claude

  - DOMAIN-SUFFIX,openai.com,AI_Services
  - DOMAIN-SUFFIX,ai.com,AI_Services
  - DOMAIN-SUFFIX,anthropic.com,AI_Services
  - DOMAIN-SUFFIX,claude.ai,AI_Services
  - DOMAIN-SUFFIX,perplexity.ai,AI_Services
  - DOMAIN-KEYWORD,openai,AI_Services
  - DOMAIN-KEYWORD,anthropic,AI_Services
  - DOMAIN-KEYWORD,claude,AI_Services
  - DOMAIN-KEYWORD,chatgpt,AI_Services
  - DOMAIN-SUFFIX,webrtc.org,REJECT  # 阻止WebRTC相关流量
  - DOMAIN-SUFFIX,rtc.org,REJECT  # 阻止RTC相关流量
  - DOMAIN-SUFFIX,peerconnection.org,REJECT  # 阻止P2P连接流量
  - RULE-SET,private,DIRECT
  - RULE-SET,reject,REJECT
  - RULE-SET,icloud,DIRECT
  - RULE-SET,apple,Apple
  - RULE-SET,google,Proxy
  - RULE-SET,proxy,Proxy
  - RULE-SET,direct,DIRECT
  - RULE-SET,lancidr,DIRECT
  - RULE-SET,cncidr,DIRECT
  - RULE-SET,telegramcidr,Telegram
  - RULE-SET,gfw,Proxy
  - RULE-SET,greatfire,Proxy
  - RULE-SET,globalmedia,GlobalMedia
  - RULE-SET,microsoft,Microsoft
  - GEOIP,CN,DIRECT
  # 添加中国电信相关规则
  - DOMAIN-SUFFIX,189.cn,ChinaTelecom
  - DOMAIN-SUFFIX,ct10000.com,ChinaTelecom
  - MATCH,Proxy

#==========高级功能==========
tun:
  enable: true
  stack: system
  dns-hijack:
    - any:53
    - tcp://any:53
  auto-route: true
  auto-detect-interface: true
  mtu: 9000  # 为千兆网络优化 (优化)

profile:
  store-selected: true
  store-fake-ip: true

sniffer:
  enable: true
  sniffing:
    - tls
    - http
  force-domain:
    - '+.google.com'
    - '+.facebook.com'
    - '+.youtube.com'
  skip-domain:
    - 'Mijia Cloud'
    - '+.apple.com'
  port-whitelist:
    - 80
    - 443

experimental:
  interface-name: eth0
  routing-mark: 6666

tcp-concurrent: true

#==========性能优化==========
tcp-fast-open: true
udp: true
quic: true
mptcp: true

experimental:
  network-config:
    tcp:
      congestion-algorithm: bbr  # 使用 BBR 拥塞控制算法 (优化)
    udp:
      timeout: 15  # 增加 UDP 超时时间 (优化)
  skip-auth-when-proxied: true  # 跳过已代理连接的身份验证 (优化)
  resolve-destination-domain: true  # 在本地解析目标域名 (优化)

#==========定时任务==========
cron:
  - '0 8 * * * clash-switch-config-work'
  - '0 18 * * * clash-switch-config-home'

#==========多配置文件支持==========
config-reload: true
configs:
  - config1.yaml
  - config2.yaml

#==========TLS 指纹==========
tls:
  fingerprint: chrome

#==========脚本支持==========
script:
  code: |
    def main(ctx, metadata):
      ip = metadata["dst_ip"]
      port = metadata["dst_port"]
      
      if port == "80" or port == "443":
        if ctx.rule_providers.geoip_cn.match(ip):
          return "DIRECT"
      
      return "Proxy"

#==========预解析域名==========
hosts:
  'mtalk.google.com': 108.177.125.188
  'dl.google.com': 180.163.151.161
  'dl.l.google.com': 180.163.151.161

#==========认证==========
authentication:
  - "user1:pass1"
  - "user2:pass2"

#==========TCP 并发==========
tcp-concurrent: true

#==========多路径 TCP==========
mptcp:
  enabled: true
  scheduler: redundant

#==========自定义出站接口==========
interface-name: eth0

#==========TTL 伪装==========
fake-ip-range: 198.18.0.1/16
fake-ip-filter:
  - '*.lan'
  - 'localhost.ptlogin2.qq.com'

#==========IPV6==========
ipv6: true

#==========UDP 支持==========
udp: true

#==========API 支持==========
external-controller: 0.0.0.0:9090
external-ui: dashboard
secret: "your_dashboard_password_here"

#==========延迟测试==========
url-test:
  url: http://www.gstatic.com/generate_204
  interval: 300
  tolerance: 150  # 增加容忍度以适应高速网络 (优化)

#==========代理缓存==========
profile:
  store-selected: true

#==========流量统计==========
profile:
  tracing: true

#==========DNS 缓存==========
dns:
  enable: true
  cache: true
  cache-size: 8192  # 增加缓存大小以提高性能

#==========节点健康检查==========
health-check:
  enable: true
  interval: 600
  url: http://www.gstatic.com/generate_204
  timeout: 5  # 减少超时时间以快速检测节点状态 (优化)

#==========千兆宽带优化设置==========
tunnel:
  mtu: 9000  # 增加 MTU 大小以提高吞吐量 (优化)
  udp-timeout: 300  # 增加 UDP 超时时间 (优化)

#==========TCP 优化==========
tcp:
  keepalive: 30  # 保持连接活跃，单位为秒 (优化)
  client-timeout: 60  # 客户端超时时间，单位为秒 (优化)
  max-wait-queue: 8192  # 最大等待队列 (优化)
  max-active-conn: 16384  # 最大活跃连接数 (优化)

#==========UDP 优化==========
udp:
  timeout: 60  # UDP 超时时间，单位为秒 (优化)
  idle-timeout: 300  # UDP 空闲超时时间，单位为秒 (优化)

#==========高级路由优化==========
routing:
  auto-detect-interface: true  # 自动检测网络接口 (优化)
  auto-route: true  # 自动配置路由 (优化)
  route-by-geoip: true  # 根据 GeoIP 进行路由 (优化)

#==========日志设置==========
log:
  level: info
  output: clash.log
  max-size: 100  # 日志文件最大大小，单位为 MB
  max-backups: 3  # 保留的旧日志文件数量

#==========中国电信 CN2 线路优化==========
proxy-groups:
  - name: CN2_Optimized
    type: url-test
    use:
      - tudou
    url: 'http://www.189.cn/test'
    interval: 300
    tolerance: 100
    filter: '(?i)CN2|中国电信|China Telecom'

rules:
  # 添加 CN2 优化规则
  - DOMAIN-SUFFIX,cn2gt.com,CN2_Optimized
  - DOMAIN-SUFFIX,cn2gy.com,CN2_Optimized
  - DOMAIN-KEYWORD,cn2,CN2_Optimized

#==========QoS 设置==========
qos:
  enable: true
  priority:
    - 'Gaming'
    - 'Streaming'
    - 'Default'

#==========网络加速==========
network-acceleration:
  enable: true
  mode: 'bbr'  # 使用 BBR 拥塞控制算法
  max-concurrent: 1024  # 最大并发连接数

#==========智能分流==========
smart-routes:
  enable: true
  rules:
    - domain: '*.qq.com'
      outbound: 'DIRECT'
    - domain: '*.taobao.com'
      outbound: 'DIRECT'
    - domain: '*.alipay.com'
      outbound: 'DIRECT'

#==========安全设置==========
security:
  encrypt-method: 'chacha20-poly1305'  # 加密方法
  dns-over-https: true  # 启用 DoH
  block-ads: true  # 启用广告拦截

#==========高级性能调优==========
performance-tuning:
  enable: true
  tcp-reuse: true  # 启用 TCP 连接重用
  tcp-fastopen: true  # 启用 TCP Fast Open
  udp-relay: true  # 启用 UDP 中继
  sndbuf: 4194304  # 发送缓冲区大小 (4MB)
  rcvbuf: 4194304  # 接收缓冲区大小 (4MB)

#==========节点自动选择==========
auto-select:
  enable: true
  check-interval: 600  # 检查间隔，单位为秒
  tolerance: 100  # 延迟容忍度，单位为毫秒
  top-speed-nodes: 5  # 选择速度最快的前 5 个节点

#==========流量控制==========
traffic-control:
  enable: true
  mode: 'intelligent'  # 智能模式
  upload-limit: 500000  # 上传限制 500Mbps
  download-limit: 1000000  # 下载限制 1Gbps

#==========中国电信专属优化==========
chinatelecom-optimization:
  enable: true
  peering-points:
    - 'AS4134'  # 中国电信 AS 号
    - 'AS4809'  # 中国电信 CN2 AS 号
  preferred-routes:
    - '202.97.0.0/16'  # 中国电信骨干网段

#==========高级 DNS 设置==========
advanced-dns:
  enable: true
  edns-client-subnet: true  # 启用 EDNS Client Subnet
  dns-over-tls: true  # 启用 DNS over TLS
  dns-over-quic: true  # 启用 DNS over QUIC

# Claude 连接说明：
# 1. 当 Claude 无法正常使用时，请在 Clash 控制面板中找到 "Claude" 代理组。
# 2. 在 "Claude" 组中，您会看到机场提供的所有可用节点列表。
# 3. 手动选择一个节点进行尝试。
# 4. 如果选择的节点无法连接 Claude，请尝试其他节点。
# 5. 持续尝试不同节点，直到找到可以正常使用 Claude 的连接。
# 6. 如果所有节点都无法连接，请检查 Claude 服务状态或稍后再试。

# 中国电信千兆宽带优化说明：
# 1. 本配置针对中国电信千兆宽带进行了多方面优化，包括 DNS、MTU、TCP/UDP 参数等。
# 2. 新增 CN2_Optimized 代理组，优先选择中国电信 CN2 线路。
# 3. 添加了智能分流规则，提高国内网站访问速度。
# 4. 启用了 QoS 和流量控制，确保重要应用获得优先带宽。
# 5. 针对中国电信网络特点，优化了路由和 DNS 设置。
# 6. 如遇网络问题，可尝试调整 MTU 值（tunnel.mtu）或 TCP/UDP 参数。
# 7. 定期更新规则提供商和代理提供商以获得最佳性能。